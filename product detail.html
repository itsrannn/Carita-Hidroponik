<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Product Detail | Carita Hidroponik</title>

    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/product detail.css" />
    <link rel="stylesheet" href="css/mobile.css" media="(max-width: 768px)" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.css"
    />
  </head>

  <body x-data @alpine:init="
    $store.products.init();
    $store.cart.init();
  ">
    <div id="header-include"></div>

    <main class="container" x-data="productDetail()" x-cloak>
      <p x-show="$store.products.isLoading" class="loading-text">Loading product...</p>

      <div x-show="!$store.products.isLoading && !product">
        <h1 class="product-detail-title">Product Not Found</h1>
        <p>
          Sorry, the product you are looking for could not be found. Please return to the
          homepage.
        </p>
      </div>

      <div x-show="!$store.products.isLoading && product">
        <section class="product-detail-banner">
          <nav class="breadcrumb">
            <a href="index.html">Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="index.html#Product">Products</a>
            <span class="breadcrumb-separator">/</span>
            <span x-text="product.name"></span>
          </nav>
        </section>

        <!-- SECTION HEAD -->
        <section class="product-detail-head">
          <div class="product-detail-img">
            <img
              :src="product.image_url ? product.image_url : 'img/general/default.jpg'"
              :alt="product.name"
            />
          </div>
          <div class="product-detail-info">
            <h2 x-text="product.category.toUpperCase()" class="badge-category"></h2>
            <h1 x-text="product.name" class="product-detail-title"></h1>

            <div class="price-container-detail" x-data="{ priceInfo: calculateDiscount(product) }">
              <template x-if="priceInfo.percentOff > 0">
                <div>
                  <span class="product-detail-price-original" x-text="formatRupiah(priceInfo.originalPrice)"></span>
                  <span class="product-detail-price-final" x-text="formatRupiah(priceInfo.finalPrice)"></span>
                  <span class="product-detail-discount-badge" x-text="'-' + priceInfo.percentOff + '%'"></span>
                </div>
              </template>
              <template x-if="!(priceInfo.percentOff > 0)">
                <p x-text="formatRupiah(priceInfo.originalPrice)" class="product-detail-price"></p>
              </template>
            </div>

            <p x-html="product.char" class="product-detail-desc-short"></p>
            <button
              @click="$store.cart.add(product.id)"
              class="btn-sm add-cart"
            >
              <i data-feather="shopping-bag"></i> Add to Cart
            </button>
          </div>
        </section>

        <!-- SECTION DESCRIPTION -->
        <section class="product-detail-description">
          <h2>Product Description</h2>
          <p x-text="product.description"></p>
        </section>

        <!-- SECTION RELATED PRODUCTS -->
        <section class="related-products">
          <h2>Related Products</h2>

          <div x-show="relatedProducts.length > 0" class="swiper related-product-slider">
            <div class="swiper-wrapper">
              <template x-for="item in relatedProducts" :key="item.id">
                <div class="swiper-slide" x-html="$store.products.renderProductCard(item)"></div>
              </template>
            </div>
            <div class="swiper-button-prev"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-pagination"></div>
          </div>

          <p x-show="relatedProducts.length === 0" class="muted" style="text-align: center;">
            No other related products.
          </p>
        </section>
      </div>
    </main>

    <div id="footer-include"></div>

    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.js"></script>

    <!-- Alpine Core -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js?nounit=true" defer></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js" defer></script>

    <!-- App Logic -->
    <script src="js/main.js" defer></script>

    <!-- General Scripts -->
    <script src="js/include.js" defer></script>
    <script src="js/script.js" defer></script>

    <script>
      function productDetail() {
        return {
          product: null,
          relatedProducts: [],
          init() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            this.$watch('$store.products.isLoading', (isLoading) => {
              if (!isLoading) {
                this.product = this.$store.products.getProductById(productId);
                if (this.product) {
                  document.title = "Carita Hidroponik | " + this.product.name;
                  this.fetchRelatedProducts();
                }
              }
            });
          },
          fetchRelatedProducts() {
            if (!this.product) return;
            this.relatedProducts = this.$store.products.all.filter(p =>
              p.category === this.product.category && String(p.id) !== String(this.product.id)
            );
            this.$nextTick(() => this.initSwiper());
          },
          formatRupiah(value) {
            if (!value) return "Rp 0";
            return "Rp " + value.toLocaleString("id-ID");
          },
          initSwiper() {
            if (this.relatedProducts.length === 0) return;
            new Swiper(".related-product-slider", {
              loop: true,
              spaceBetween: 15,
              navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
              },
              pagination: {
                el: ".swiper-pagination",
                clickable: true,
              },
              breakpoints: {
                320: { slidesPerView: 2, spaceBetween: 10 },
                768: { slidesPerView: 5, spaceBetween: 20 },
              },
            });
            this.$nextTick(() => feather.replace());
          },
        }
      }
    </script>
  </body>
</html>
