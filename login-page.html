<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Login Page | Carita Hidroponik</title>
    <link rel="icon" type="image/x-icon" href="img/Logo.jpg" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/login-page.css" />
    <link rel="stylesheet" href="css/mobile.css" media="(max-width: 768px)" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script src="js/supabase-client.js"></script>
  </head>

  <body x-data @alpine:init="$store.i18n.init()">
    <div id="header-include"></div>

    <section class="login">
      <div class="container">
        <section>
          <div class="login-form active" id="login-form">
            <form>
              <input type="hidden" name="login" value="1" />
              <h1 x-text="$store.i18n.t('login.loginTitle')">Login</h1>
              <div class="input-box">
                <input type="email" name="email" :placeholder="$store.i18n.t('login.emailPlaceholder')" required />
                <i data-feather="mail"></i>
              </div>

              <div class="input-box">
                <input
                  type="password"
                  name="password"
                  :placeholder="$store.i18n.t('login.passwordPlaceholder')"
                  required
                />
                <i data-feather="lock"></i>
                <i class="password-toggle-icon" data-feather="eye"></i>
              </div>
              <div class="remember-forgot">
                <label><input type="checkbox" /><span x-text="$store.i18n.t('login.rememberMe')">Remember me</span></label>
                <a href="#" x-text="$store.i18n.t('login.forgotPassword')">Forgot Password?</a>
              </div>
              <div class="btn-wrapper">
                <button type="submit" class="btn" x-text="$store.i18n.t('login.loginButton')">Login</button>
              </div>
              <div class="register-link">
                <p>
                  <span x-text="$store.i18n.t('login.noAccount')">Don't have an account?</span>
                  <a href="#" onclick="showForm('register-form')" x-text="$store.i18n.t('login.registerLink')">Register</a>
                </p>
              </div>
            </form>
          </div>
          <div id="verification-message" style="text-align: center; color: var(--text-color); display: none;">
            <h2 x-text="$store.i18n.t('login.verification.title')">Registration Successful!</h2>
            <p x-text="$store.i18n.t('login.verification.message')">We have sent a verification link to your email. Please check your inbox to complete the registration.</p>
          </div>
        </section>
        <section>
          <div class="login-form" id="register-form">
            <form>
              <input type="hidden" name="register" value="1" />
              <h1 x-text="$store.i18n.t('login.registerTitle')">Register</h1>

              <div class="input-box">
                <input type="text" name="name" :placeholder="$store.i18n.t('login.namePlaceholder')" required />
                <i data-feather="user"></i>
              </div>

              <div class="input-box">
                <input type="email" name="email" :placeholder="$store.i18n.t('login.emailPlaceholder')" required />
                <i data-feather="mail"></i>
              </div>
              <span id="email-domain-error" class="error-message" style="display: block; color: red; text-align: left; width: 100%; padding: 0 5px; font-size: 0.8rem; margin-top: -10px; margin-bottom: 10px; visibility: hidden;"></span>

              <div class="input-box">
                <input
                  type="password"
                  name="password"
                  :placeholder="$store.i18n.t('login.passwordPlaceholder')"
                  required
                />
                <i data-feather="lock"></i>
                <i class="password-toggle-icon" data-feather="eye"></i>
              </div>

              <div class="remember-forgot">
                <label><input type="checkbox" /> <span x-text="$store.i18n.t('login.rememberMe')">Remember me</span></label>
              </div>

              <div class="btn-wrapper">
                <button type="submit" class="btn" x-text="$store.i18n.t('login.registerLink')">Register</button>
              </div>

              <div class="register-link">
                <p>
                  <span x-text="$store.i18n.t('login.alreadyAccount')">Already have an account?</span>
                  <a href="#" onclick="showForm('login-form')" x-text="$store.i18n.t('login.loginLink')">Login</a>
                </p>
              </div>
            </form>
          </div>
        </section>
      </div>
    </section>

    <div id="footer-include"></div>

    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js" defer ></script>

    <script src="js/main.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => feather.replace());
    </script>
    <script>
      function showForm(formIdToShow) {
        document.querySelectorAll(".login-form").forEach((form) => {
          form.classList.remove("active");
        });

        const targetForm = document.getElementById(formIdToShow);
        if (targetForm) {
          targetForm.classList.add("active");
        }
      }
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const loginForm = document.querySelector('#login-form form');
        const registerForm = document.querySelector('#register-form form');

        // --- Role-based redirection logic ---
        const handleRedirect = async (user) => {
          // Attempt to fetch the user's role.
          const { data: profile } = await supabase
            .from('profiles')
            .select('role')
            .eq('id', user.id)
            .single();

          // Secure default: if profile doesn't load or role is not admin,
          // redirect to the customer account page.
          if (profile && profile.role && profile.role.toLowerCase() === 'admin') {
            window.location.href = 'admin.html';
          } else {
            window.location.href = 'my-account.html';
          }
        };

        // --- Login Form Handler ---
        loginForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const email = loginForm.email.value;
          const password = loginForm.password.value;

          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
          });

          if (error) {
            alert(`Error: ${error.message}`);
          } else if (data.user) {
            const urlParams = new URLSearchParams(window.location.search);
            const redirectUrl = urlParams.get('redirect');

            if (redirectUrl) {
              window.location.href = redirectUrl;
            } else {
              await handleRedirect(data.user);
            }
          }
        });

        // --- Registration Form Handler ---
        registerForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const name = registerForm.name.value;
          const email = registerForm.email.value;
          const password = registerForm.password.value;
          const errorSpan = document.getElementById('email-domain-error');

          const allowedDomains = [
            '@gmail.com',
            '@yahoo.com',
            '@yahoo.co.id',
            '@outlook.com',
            '@hotmail.com',
            '@icloud.com'
          ];

          const emailDomain = email.substring(email.lastIndexOf('@'));

          if (!allowedDomains.includes(emailDomain)) {
            errorSpan.textContent = "Gunakan email dengan domain umum seperti Gmail, Yahoo, atau Outlook.";
            errorSpan.style.visibility = 'visible';
            return;
          } else {
            errorSpan.style.visibility = 'hidden';
          }

          const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: {
              data: { full_name: name }
            }
          });

          if (error) {
            alert(`Error: ${error.message}`);
          } else {
            // Show the global notification
            window.showNotification("Pendaftaran Berhasil");

            // Redirect to login page after a short delay
            setTimeout(() => {
              window.location.href = 'login-page.html';
            }, 2000); // 2-second delay
          }
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => feather.replace());
    </script>

    <script>
      // === Password Toggle Functionality ===
      // Use event delegation to ensure the click handler works even after the icon is replaced by Feather Icons.
      document.addEventListener('click', function (e) {
        const icon = e.target.closest('.password-toggle-icon');
        if (!icon) return;

        const inputBox = icon.closest('.input-box');
        if (!inputBox) return;

        const passwordInput = inputBox.querySelector('input[type="password"], input[type="text"]');
        if (!passwordInput) return;

        // Toggle input type
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';

        // Create a new <i> element to replace the old <svg> icon
        const newIcon = document.createElement('i');
        newIcon.className = 'password-toggle-icon';
        newIcon.setAttribute('data-feather', isPassword ? 'eye-off' : 'eye');

        // Replace the old icon with the new one
        icon.replaceWith(newIcon);

        // Tell Feather Icons to process the new icon
        feather.replace();
      });
    </script>
  </body>
</html>
