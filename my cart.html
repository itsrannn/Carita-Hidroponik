<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>My Cart | Carita Hidroponik</title>

    <!-- ========== STYLE ========== -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/my cart.css" />
    <link rel="stylesheet" href="css/mobile.css" media="(max-width: 768px)" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
  </head>

  <body x-data @alpine:init="
    $store.products.init();
    $store.cart.init();
  ">
    <div id="header-include"></div>

    <main class="main-content" x-data="checkoutPage()">
      <section class="cart-section">
        <div class="container">
          <h2 class="section-title">Shopping Cart</h2>
          <div class="cart-layout">
            <!-- CART ITEMS -->
            <div class="cart-items-container">
              <div class="cart-header">
                <div class="header-product">Product</div>
                <div class="header-quantity">Quantity</div>
                <div class="header-total">Total</div>
              </div>

              <div id="cart-items-list">
                <template x-if="$store.cart.items.length === 0">
                  <p class="cart-empty-message">Your shopping cart is empty.</p>
                </template>

                <template x-for="item in $store.cart.details" :key="item.id" x-init="$nextTick(() => feather.replace())">
                  <div class="cart-item">
                    <div class="cart-item-product">
                      <img :src="item.img" :alt="item.name" class="cart-item-image" />
                      <div class="cart-item-details">
                        <h4 class="item-name" x-text="item.name"></h4>
                        <div class="price-container-cart">
                          <template x-if="item.percentOff > 0">
                            <div>
                              <span class="item-price-original" x-text="window.formatRupiah(item.price)"></span>
                              <span class="item-price-final" x-text="window.formatRupiah(item.finalPrice)"></span>
                            </div>
                          </template>
                          <template x-if="!(item.percentOff > 0)">
                            <div class="item-price" x-text="window.formatRupiah(item.price)"></div>
                          </template>
                        </div>
                      </div>
                    </div>
                    <div class="cart-item-quantity">
                      <button class="quantity-btn" @click="$store.cart.remove(item.id)" aria-label="Decrease">-</button>
                      <span class="quantity-value" x-text="item.quantity"></span>
                      <button class="quantity-btn" @click="$store.cart.add(item.id)" aria-label="Increase">+</button>
                    </div>
                    <div class="cart-item-total" x-text="window.formatRupiah(item.subtotal)"></div>
                    <button class="cart-item-remove" @click="$store.cart.remove(item.id, true)" aria-label="Remove item">
                      <i data-feather="trash-2"></i>
                    </button>
                  </div>
                </template>
              </div>

              <a href="index.html#Product" class="continue-shopping">
                <i data-feather="arrow-left"></i> Continue Shopping
              </a>
            </div>

            <!-- SUMMARY -->
            <div class="cart-summary">
              <h3>Order Summary</h3>

              <div class="coupon-form">
                <input type="text" placeholder="Enter Coupon Code" />
                <button class="btn btn-secondary">Apply</button>
              </div>

              <div class="summary-item">
                <span>Subtotal</span>
                <span id="summary-subtotal" x-text="window.formatRupiah($store.cart.total)"></span>
              </div>
              <div class="summary-item">
                <span>Shipping</span>
                <span id="summary-shipping">Rp 0</span>
              </div>

              <div class="summary-total">
                <span>Total</span>
                <span id="summary-total" x-text="window.formatRupiah($store.cart.total)"></span>
              </div>

              <button
                @click="handleCheckout()"
                class="btn btn-primary btn-block"
                :disabled="$store.cart.items.length === 0"
              >
                Proceed to Checkout
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- ========== NOTIFICATION MODAL ========== -->
      <div x-show="isProfileModalOpen" class="modal-overlay" style="display: none;">
        <div class="modal-content" @click.outside="isProfileModalOpen = false">
          <h3 class="modal-title">Profile Incomplete</h3>
          <p class="modal-body">
            To proceed with checkout, you must complete your profile information first.
          </p>
          <div class="modal-actions">
            <button @click="isProfileModalOpen = false" class="btn btn-secondary">Later</button>
            <a href="my account.html" class="btn btn-primary">Complete Profile</a>
          </div>
        </div>
      </div>

      <div id="notification" class="notification"></div>

      <div x-show="isLoginModalOpen" class="modal-overlay" style="display: none;">
        <div class="modal-content" @click.outside="isLoginModalOpen = false">
          <h3 class="modal-title">You Are Not Logged In</h3>
          <p class="modal-body">
            Please log in or create an account to continue with the checkout process.
          </p>
          <div class="modal-actions">
            <button @click="isLoginModalOpen = false" class="btn btn-secondary">Close</button>
            <a href="login page.html" class="btn btn-primary">Login or Register</a>
          </div>
        </div>
      </div>

      <div x-show="isConfirmModalOpen" class="modal-overlay" style="display: none;">
        <div class="modal-content" @click.outside="isConfirmModalOpen = false">
          <h3 class="modal-title">Confirm Your Order</h3>
          <div class="confirmation-summary">
             <template x-for="item in $store.cart.details" :key="item.id">
                <div class="summary-product-item">
                  <span class="summary-product-name" x-text="`${item.name} (x${item.quantity})`"></span>
                  <span class="summary-product-total" x-text="window.formatRupiah(item.subtotal)"></span>
                </div>
              </template>
              <div class="summary-grand-total">
                <span x-text="`Total: ${window.formatRupiah($store.cart.total)}`"></span>
              </div>
          </div>
          <div class="modal-actions">
            <button @click="isConfirmModalOpen = false" class="btn btn-secondary">Cancel</button>
            <button @click="confirmAndProcessCheckout()" class="btn btn-primary">Confirm & Order</button>
          </div>
        </div>
      </div>
    </main>

    <div id="footer-include"></div>

    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js?nounit=true" defer></script>

    <script>
    function checkoutPage() {
      return {
        isProfileModalOpen: false,
        isLoginModalOpen: false,
        isConfirmModalOpen: false,
        userProfile: null,

        async handleCheckout() {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            this.isLoginModalOpen = true;
            return;
          }

          const { complete, profile } = await this.isProfileComplete();
          if (!complete) {
            this.isProfileModalOpen = true;
            return;
          }
          this.userProfile = profile;
          this.isConfirmModalOpen = true;
        },

        async confirmAndProcessCheckout() {
          if (this.userProfile) {
            await this.processCheckout(this.userProfile);
          } else {
            // Re-validate just in case
            const { complete, profile } = await this.isProfileComplete();
            if (complete) {
              await this.processCheckout(profile);
            } else {
              this.isConfirmModalOpen = false;
              this.isProfileModalOpen = true;
            }
          }
        },

        async isProfileComplete() {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) return { complete: false, profile: null };

          const { data, error } = await supabase
            .from('profiles')
            .select('full_name, phone_number, address, postal_code, province, regency, district, village, latitude, longitude')
            .eq('id', session.user.id)
            .single();

          if (error) return { complete: false, profile: null };

          const requiredFields = ['full_name', 'phone_number', 'address', 'postal_code', 'province', 'regency', 'district', 'village'];
          for (const f of requiredFields) {
            if (!data[f] || String(data[f]).trim() === '') return { complete: false, profile: data };
          }
          if (data.latitude == null || data.longitude == null || (data.latitude === 0 && data.longitude === 0)) {
            return { complete: false, profile: data };
          }
          return { complete: true, profile: data };
        },

        async processCheckout(profile) {
          if (this.$store.cart.items.length === 0) {
            window.showNotification('Your shopping cart is empty.', true);
            return;
          }

          const { data: { user } } = await supabase.auth.getUser();
          if (!user) {
            window.showNotification('Session not found. Please log in again.', true);
            return;
          }

          const orderCode = this.generateOrderCode();
          const orderDetails = this.$store.cart.details.map(item => ({
            product_id: item.id, name: item.name, quantity: item.quantity, price: item.price, subtotal: item.subtotal
          }));

          const { error } = await supabase.from('orders').insert({
            user_id: user.id,
            order_code: orderCode,
            order_details: orderDetails,
            shipping_address: { ...profile },
            total_amount: this.$store.cart.total,
            status: 'Menunggu Konfirmasi'
          });

          if (error) {
            window.showNotification(`An error occurred: ${error.message}`, true);
            return;
          }

          this.$store.cart.clear(); // Use the store's method
          window.showNotification(`Your order with code ${orderCode} has been placed successfully!`);

          setTimeout(() => { window.location.href = 'order-history.html'; }, 1500);
        },

        generateOrderCode() {
          const date = new Date();
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, '0');
          const d = String(date.getDate()).padStart(2, '0');
          const random = Math.random().toString(36).substring(2, 6).toUpperCase();
          return `CH-${y}${m}${d}-${random}`;
        }
      }
    }
    </script>
  </body>
</html>
